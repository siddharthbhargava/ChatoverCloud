var MongoClient = require('mongodb').MongoClient;

function insertConversation(json){
	
	/*
	 * The above JSNON object must be of the form:
	 * {"clientID":value,
	 *  "timeStamp":value,
	 *  "clientMessage":value,
	 *  "customerMessage":value,
	 *  "unreadFlag":value}
	 */

	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		  if(err) throw err;
		  else
			{
			  if(json.clientID!=NULL && json.timeStamp!=NULL && json.unreadFlag!=NULL){
				  db.collection("conversationDB", function (err, connection){
				  		connection.insert(json,function (err,result){
				  			if(err)
				  				console.log(err);
				  			else
					  			console.log("Successfully Inserted");
					  	});
					  });
				}
				  else{
						console.log("Incomplete data.");
				}
		}
			  
	});
}

exports.insertConversation = insertConversation;

function updateConversation(json){

	/*
	 * The above JSNON object must be of the form:
	 * {"clientID":value,
	 *  "timeStamp":value,
	 *  "clientMessage":value,
	 *  "customerMessage":value,
	 *  "unreadFlag":value}
	 */

	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			if(json.clientID!=NULL && json.timeStamp!=NULL && json.unreadFlag!=NULL){
		
				db.collection("conversationDB", function (err, connection){
					connection.update(json,function (err,result){
						if(err)
							console.log(err);
						else
							console.log("Successfully Updated");
					});
				});
			}
			else{
					console.log("Updated data.");
			}
		}
	  
	});
}
				
exports.updateConversation = updateConversation;

function removeConversation(json){

	/*
	 * The above JSNON object must be of the form:
	 * {"clientID":value,
	 *  "timeStamp":value,
	 *  "clientMessage":value,
	 *  "customerMessage":value,
	 *  "unreadFlag":value}
	 */

	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			if(json.clientID!=NULL && json.timeStamp!=NULL && json.unreadFlag!=NULL){
		
				db.collection("conversationDB", function (err, connection){
					connection.remove(json,function (err,result){
						if(err)
							console.log(err);
						else
							console.log("Successfully Removed.");
					});
				});
			}
			else{
					console.log("Cannot remove conversation.");
			}
		}
	  
	});
}

exports.removeConversation = removeConversation;

function findAllConversations(callback){
	
	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			db.collection("conversationDB", function (err, connection){
			connection.find(function(err, results){
				if(!err){
					callback(results,err);
				}
				
				});
			});
		}
	});
}

exports.findAllConversations = findAllConversations;

function findConversationByClient(callback,json){
	
	/*
	 * The above JSON object must contain the clientID in the form: {"clientID":value}
	 */
	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			db.collection("conversationDB", function (err, connection){
			connection.find({"clientID":json.clientID},function(err,res){
				if(err){
					console.log("Incorrect Client ID");
				}
				else{
					callback(res,err);
				}
			});
		});
	}
	});
}

exports.findConversationByClient = findConversationByClient;



function findUnreadMessagesByClient(callback,json){
	
	/*The above JSON object should contain the Client ID in the form: {"clientID":value}*/
	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			db.collection("conversationDB", function (err, connection){
				connection.find({"clientID:":json.clientID, "unreadFlag":{$in:[1]}},function(err,res){
					if(!err){
						callback(res);
					}
					else{
						console.log("Client has no unread messages");
					}
		
				});
			});
		}
	});
}

exports.findUnreadMessagesByClient = findUnreadMessagesByClient;

function removeReadConversationByClient(json){
	
	/*The above JSON object should contain the Client ID in the form: {"clientID":value}*/
	MongoClient.connect('mongodb://127.0.0.1:27017/chatDB', function(err, db) {
		if(err) throw err;
		else
		{
			db.collection("conversationDB", function (err, connection){
				connection.remove({"clientID:":json.clientID, "unreadFlag":{$in:[0]}},function(err,res){
					if(err){
						console.log("Error removing documents");
					}
					else{
						console.log("Removed read messages of the client.");
					}
				});
			});
		}
	});
}
exports.removeReadConversationByClient = removeReadConversationByClient;
